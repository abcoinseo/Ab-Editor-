<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Project</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #fff; }
        .status-message { display: flex; align-items: center; justify-content: center; height: 100%; font-family: Arial, sans-serif; font-size: 1.5em; color: #555; padding: 20px; text-align: center; }
        iframe#contentFrame { width: 100%; height: 100%; border: none; display: none; } /* Initially hidden */
    </style>
</head>
<body>
    <div id="statusDisplay" class="status-message">Loading project...</div>
    <iframe id="contentFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation"></iframe>

    <script>
        const firebaseConfig = { // PASTE YOUR FIREBASE CONFIG AGAIN HERE
            apiKey: "AIzaSyD3kO_ULF76RJkJf1yhvo5cdM4Hoqo4fHA",
            authDomain: "abcoinseo-e2f66.firebaseapp.com",
            databaseURL: "https://abcoinseo-e2f66-default-rtdb.firebaseio.com",
            projectId: "abcoinseo-e2f66",
            storageBucket: "abcoinseo-e2f66.firebasestorage.app",
            messagingSenderId: "396837162872",
            appId: "1:396837162872:web:c204ca5c36f5d2d87bc28d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const statusDisplay = document.getElementById('statusDisplay');
        const contentFrame = document.getElementById('contentFrame');

        function showStatus(message, isError = false) {
            statusDisplay.textContent = message;
            statusDisplay.style.color = isError ? '#d9534f' : '#555';
            statusDisplay.style.display = 'flex';
            contentFrame.style.display = 'none';
            document.title = isError ? "Error" : "Status";
        }

        async function loadAndRenderProject(projectId) {
            document.title = `Loading: ${projectId}...`;
            try {
                const snapshot = await db.ref(`hosted_content/${projectId}`).once('value');
                if (!snapshot.exists()) {
                    showStatus(`Error: Project '${projectId}' not found. It may have been deleted or the link is incorrect.`, true);
                    return;
                }

                const project = snapshot.val();
                if (!project.files || !project.files["index.html"]) {
                    showStatus(`Error: Project '${projectId}' is incomplete (missing index.html or files).`, true);
                    return;
                }
                
                document.title = project.metadata?.name ? `View: ${project.metadata.name}` : `View Project: ${projectId}`;

                let htmlContent = project.files["index.html"];
                const cssFileContent = project.files["style.css"] || "";
                const jsFileContent = project.files["script.js"] || "";

                // Strategy 1: Inject CSS and JS directly into the HTML string (Simpler for srcdoc)
                // Replace <link rel="stylesheet" href="style.css"> with <style>...</style>
                htmlContent = htmlContent.replace(
                    /<link\s+.*?href=["']style\.css["'].*?>/i, 
                    `<style>\n${cssFileContent}\n</style>`
                );
                // Replace <script src="script.js"></script> with <script>...</script>
                // Be careful with "<\/script>" if it appears in user's JS. For srcdoc, it's less of an issue.
                htmlContent = htmlContent.replace(
                    /<script\s+.*?src=["']script\.js["'].*?><\/script>/i,
                    `<script>\n${jsFileContent}\n<\/script>`
                );
                // Also handle deferred/async scripts if any are expected
                htmlContent = htmlContent.replace(
                    /<script\s+.*?src=["']script\.js["'].*?(defer|async).*?><\/script>/i,
                    `<script defer>\n${jsFileContent}\n<\/script>` 
                );


                // Strategy 2 (More Complex, better for Blob URLs, but srcdoc is fine for this):
                // Create Blob URLs for CSS/JS and modify HTML to point to them.
                // This is harder to get right with srcdoc as Blob URLs are origin-bound.

                contentFrame.srcdoc = htmlContent;
                statusDisplay.style.display = 'none';
                contentFrame.style.display = 'block';

            } catch (error) {
                console.error("Error loading project:", error);
                showStatus(`An error occurred: ${error.message}`, true);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const projectId = window.location.hash.substring(1);
            if (projectId) {
                loadAndRenderProject(projectId);
            } else {
                showStatus("Error: No project ID specified. Append #PROJECT_ID to the URL.", true);
            }
        });
    </script>
</body>
</html>
