<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AB Multi-File Project Editor</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; background: #1e1e2f; color: #fff; font-family: Arial, sans-serif; display: flex; flex-direction: column; }
    header { display: flex; justify-content: space-between; padding: 10px 20px; background: #292944; align-items: center; flex-shrink: 0; }
    header h1 { font-size: 1.2rem; }
    header .controls { display: flex; gap: 15px; }
    header .material-icons, header button { cursor: pointer; background: none; border: none; color: white; padding: 5px;}
    header button { background-color: #4CAF50; border-radius: 4px; }

    .project-info { padding: 10px 20px; background: #252538; font-size: 0.9rem; }
    .project-info input { background: #1e1e2f; color: white; border: 1px solid #444; padding: 5px; margin-left: 10px; border-radius: 3px;}

    .editor-area { display: flex; flex-grow: 1; overflow: hidden; }
    .file-tabs { display: flex; background: #2d2d3c; padding: 5px; border-bottom: 1px solid #292944; flex-shrink: 0;}
    .file-tab { padding: 8px 15px; background: #3c3c52; border-radius: 4px 4px 0 0; margin-right: 2px; cursor: pointer; font-size: 0.9rem;}
    .file-tab.active { background: #1e1e2f; border: 1px solid #292944; border-bottom: 1px solid #1e1e2f; position: relative; top: 1px; font-weight: bold; }
    
    .main-content { display: flex; flex-direction: column; flex-grow: 1; }
    .code-editor-wrapper { flex-grow: 1; position: relative; }
    textarea.code-area { width: 100%; height: 100%; padding: 10px; background: #1e1e2f; color: #ccc; resize: none; border: none; font-family: monospace; outline: none; }
    
    .actions-bar { display: flex; padding: 8px 10px; background: #292944; justify-content: flex-end; align-items: center; border-top: 1px solid #33334d; flex-shrink: 0;}
    .actions-bar .material-icons { cursor: pointer; margin: 0 8px; font-size: 20px; }
    .actions-bar .material-icons:hover { color: #aaa; }

    /* Modal Styles (same as before, slightly adapted) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.visible { display: flex; }
    .modal-content { background: #2d2d3c; color: #fff; padding: 25px 30px; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.4); width: 90%; max-width: 550px; text-align: center; }
    .modal-content h2 { margin-top: 0; margin-bottom: 15px; color: #82aaff; font-size: 1.6rem; }
    .modal-content p { margin-bottom: 12px; font-size: 0.95rem; color: #ccc; }
    #hostedLinkInput { width: 100%; padding: 12px; margin-bottom: 25px; border: 1px solid #4c4c66; border-radius: 4px; background: #1e1e2f; color: #e0e0e0; font-size: 0.9rem; text-align: left; font-family: monospace; }
    .modal-actions { display: flex; justify-content: center; gap: 15px; }
    .modal-button { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s, transform 0.1s; }
    .modal-button:active { transform: scale(0.98); }
    .modal-button.copy-button { background-color: #4CAF50; color: white; }
    .modal-button.close-button { background-color: #6c757d; color: white; }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinning { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
  <header>
    <h1>AB Project Editor</h1>
    <div class="controls">
        <button onclick="createNewProject()">New Project</button>
        <input type="text" id="projectToLoadId" placeholder="Enter Project ID to Load">
        <button onclick="loadProjectFromInput()">Load Project</button>
    </div>
  </header>

  <div class="project-info">
    Project Name: <input type="text" id="projectName" placeholder="My Awesome Project">
    Project ID: <span id="currentProjectIdDisplay">N/A (Create or Load a Project)</span>
  </div>

  <div class="main-content">
    <div class="file-tabs" id="fileTabsContainer">
      <!-- Tabs will be generated here -->
    </div>
    <div class="code-editor-wrapper">
      <textarea id="code" class="code-area" spellcheck="false" placeholder="Create or load a project. Then select a file (HTML, CSS, JS) to edit."></textarea>
    </div>
  </div>
  
  <div class="actions-bar">
    <span class="material-icons" onclick="saveProjectToFirebase()" title="Save Project to Cloud">cloud_upload</span>
    <span class="material-icons" onclick="hostCurrentProject()" title="Host Project Publicly">public</span>
  </div>

  <div class="modal-overlay" id="hostingPopupOverlay">
    <div class="modal-content">
      <h2>Project Hosted!</h2>
      <p>Your project is publicly accessible at:</p>
      <input type="text" id="hostedLinkInput" readonly>
      <div class="modal-actions">
        <button onclick="copyHostedLink()" class="modal-button copy-button">Copy Link</button>
        <button onclick="closeHostingPopup()" class="modal-button close-button">Close</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3kO_ULF76RJkJf1yhvo5cdM4Hoqo4fHA", // YOUR PROVIDED CONFIG
      authDomain: "abcoinseo-e2f66.firebaseapp.com",
      databaseURL: "https://abcoinseo-e2f66-default-rtdb.firebaseio.com",
      projectId: "abcoinseo-e2f66",
      storageBucket: "abcoinseo-e2f66.firebasestorage.app",
      messagingSenderId: "396837162872",
      appId: "1:396837162872:web:c204ca5c36f5d2d87bc28d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const codeTextarea = document.getElementById('code');
    const fileTabsContainer = document.getElementById('fileTabsContainer');
    const projectNameInput = document.getElementById('projectName');
    const currentProjectIdDisplay = document.getElementById('currentProjectIdDisplay');
    const projectToLoadIdInput = document.getElementById('projectToLoadId');
    
    const hostingPopupOverlay = document.getElementById('hostingPopupOverlay');
    const hostedLinkInput = document.getElementById('hostedLinkInput');

    let currentProjectID = null;
    let projectData = { // Holds files for the current project
        // "index.html": "content", "style.css": "content", "script.js": "content"
    };
    let activeFileName = null; // e.g., "index.html"
    const defaultFiles = ["index.html", "style.css", "script.js"];

    // --- Utility Functions ---
    function generateRandomId(length = 12) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function saveCurrentProjectToLocalStorage() {
        if (currentProjectID) {
            localStorage.setItem('lastActiveProjectID', currentProjectID);
            // For a list:
            // let recentProjects = JSON.parse(localStorage.getItem('recentProjectIDs')) || [];
            // if (!recentProjects.includes(currentProjectID)) recentProjects.unshift(currentProjectID);
            // localStorage.setItem('recentProjectIDs', JSON.stringify(recentProjects.slice(0, 5))); // Keep last 5
        }
    }

    function loadLastActiveProjectFromLocalStorage() {
        const lastID = localStorage.getItem('lastActiveProjectID');
        if (lastID) {
            loadProject(lastID);
        } else {
            updateUIForNoProject();
        }
    }

    // --- UI Update Functions ---
    function renderFileTabs() {
        fileTabsContainer.innerHTML = '';
        if (!currentProjectID) return;

        defaultFiles.forEach(fileName => {
            const tab = document.createElement('div');
            tab.className = 'file-tab' + (fileName === activeFileName ? ' active' : '');
            tab.textContent = fileName;
            tab.onclick = () => openFileInEditor(fileName);
            fileTabsContainer.appendChild(tab);
        });
    }

    function updateUIForNewProject(newId, name) {
        currentProjectID = newId;
        projectNameInput.value = name || "New Project";
        currentProjectIdDisplay.textContent = newId;
        codeTextarea.value = '';
        codeTextarea.placeholder = "Select a file (HTML, CSS, JS) to edit.";
        renderFileTabs();
        saveCurrentProjectToLocalStorage();
    }
    
    function updateUIForNoProject() {
        currentProjectID = null;
        projectData = {};
        activeFileName = null;
        projectNameInput.value = "";
        currentProjectIdDisplay.textContent = "N/A";
        codeTextarea.value = '';
        codeTextarea.placeholder = "Create or load a project to start.";
        fileTabsContainer.innerHTML = '<div class="file-tab">No Project Loaded</div>';
    }

    function openFileInEditor(fileName) {
        if (!currentProjectID || !projectData.hasOwnProperty(fileName)) {
            // If file doesn't exist in projectData, it means it's a new file for this project
            // or projectData hasn't been fully loaded yet. For simplicity, assume it's new or default.
            if (!projectData[fileName]) {
                 if (fileName === "index.html") projectData[fileName] = `<!DOCTYPE html>\n<html>\n<head>\n  <title>${projectNameInput.value || 'Project'}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Hello from ${projectNameInput.value || 'Project'}!</h1>\n  <script src="script.js"><\/script>\n</body>\n</html>`;
                 else if (fileName === "style.css") projectData[fileName] = `body {\n  font-family: sans-serif;\n  margin: 20px;\n  background-color: #f0f0f0;\n}`;
                 else if (fileName === "script.js") projectData[fileName] = `console.log('Project script loaded!');\n\n// Add your JavaScript here`;
                 else projectData[fileName] = ""; // Default empty for other files
            }
        }
        activeFileName = fileName;
        codeTextarea.value = projectData[fileName] || "";
        codeTextarea.focus();
        renderFileTabs();
    }

    // --- Project Management Functions ---
    function createNewProject() {
        if (currentProjectID && Object.keys(projectData).some(f => projectData[f].trim() !== defaultContentForFile(f,"").trim())) {
            if (!confirm("You have unsaved changes in the current project. Are you sure you want to create a new project? Changes will be lost if not saved to cloud.")) {
                return;
            }
        }

        const newId = generateRandomId();
        const defaultProjectName = "My New Project";
        projectData = {}; // Reset project data for the new project

        defaultFiles.forEach(fName => {
            projectData[fName] = defaultContentForFile(fName, defaultProjectName);
        });
        
        updateUIForNewProject(newId, defaultProjectName);
        openFileInEditor("index.html"); // Open index.html by default
    }
    
    function defaultContentForFile(fileName, projName) {
        if (fileName === "index.html") return `<!DOCTYPE html>\n<html>\n<head>\n  <title>${projName}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Hello from ${projName}!</h1>\n  <script src="script.js"><\/script>\n</body>\n</html>`;
        if (fileName === "style.css") return `body {\n  font-family: sans-serif;\n  margin: 20px;\n  background-color: #f0f0f0;\n}`;
        if (fileName === "script.js") return `console.log('${projName} script loaded!');`;
        return "";
    }


    function loadProjectFromInput() {
        const idToLoad = projectToLoadIdInput.value.trim();
        if (idToLoad) {
            loadProject(idToLoad);
        } else {
            alert("Please enter a Project ID to load.");
        }
    }

    async function loadProject(projectId) {
        if (!projectId) return;
        console.log(`Attempting to load project: ${projectId}`);
        try {
            const snapshot = await db.ref(`projects/${projectId}`).once('value');
            if (snapshot.exists()) {
                const proj = snapshot.val();
                currentProjectID = projectId;
                projectNameInput.value = proj.metadata.name || "Untitled Project";
                projectData = proj.files || {};
                
                // Ensure default files exist if not in loaded data
                defaultFiles.forEach(fName => {
                    if (!projectData.hasOwnProperty(fName)) {
                        projectData[fName] = defaultContentForFile(fName, projectNameInput.value);
                    }
                });

                currentProjectIdDisplay.textContent = currentProjectID;
                projectToLoadIdInput.value = ''; // Clear input
                openFileInEditor(proj.metadata.mainFile || "index.html"); // Open main or index
                saveCurrentProjectToLocalStorage();
                alert(`Project '${projectNameInput.value}' loaded successfully!`);
            } else {
                alert(`Project with ID '${projectId}' not found in the cloud.`);
                updateUIForNoProject();
            }
        } catch (error) {
            console.error("Error loading project:", error);
            alert(`Error loading project: ${error.message}`);
            updateUIForNoProject();
        }
    }

    async function saveProjectToFirebase() {
        if (!currentProjectID) {
            alert("No active project to save. Create or load a project first.");
            return;
        }
        if (activeFileName && projectData.hasOwnProperty(activeFileName)) { // Save current editor content to projectData
            projectData[activeFileName] = codeTextarea.value;
        }

        const projectToSave = {
            metadata: {
                name: projectNameInput.value.trim() || "Untitled Project",
                mainFile: "index.html", // Assuming index.html is always the main
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            },
            files: projectData
        };

        try {
            await db.ref(`projects/${currentProjectID}`).set(projectToSave);
            // Also update the hosted version if it exists or create it
            await db.ref(`hosted_content/${currentProjectID}`).set({
                metadata: projectToSave.metadata, // Keep metadata consistent
                files: projectToSave.files,       // Save all files for hosting
                lastHosted: firebase.database.ServerValue.TIMESTAMP
            });
            alert(`Project '${projectToSave.metadata.name}' (ID: ${currentProjectID}) saved and hosted version updated!`);
            saveCurrentProjectToLocalStorage(); // Update local storage reference
        } catch (error) {
            console.error("Error saving project:", error);
            alert(`Error saving project: ${error.message}`);
        }
    }
    
    // --- Hosting Functions (similar to before, adapted for project ID) ---
    function showHostingPopup(url) {
        hostedLinkInput.value = url;
        hostingPopupOverlay.classList.add('visible');
        hostedLinkInput.focus(); hostedLinkInput.select();
    }
    function closeHostingPopup() { hostingPopupOverlay.classList.remove('visible'); }
    function copyHostedLink() {
        hostedLinkInput.select();
        hostedLinkInput.setSelectionRange(0, 99999); 
        try {
            document.execCommand('copy');
            alert('Link copied!');
        } catch (err) { alert('Failed to copy.'); }
    }

    async function hostCurrentProject() {
        if (!currentProjectID) {
            alert("No active project to host. Save it first.");
            return;
        }
        // Ensure project is saved before generating link (or save implicitly)
        await saveProjectToFirebase(); 

        // Construct the public URL
        const publicUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$|$/, '')}view.html#${currentProjectID}`;
        showHostingPopup(publicUrl);
    }

    // --- Event Listeners & Initialization ---
    codeTextarea.addEventListener('input', () => {
        if (currentProjectID && activeFileName && projectData.hasOwnProperty(activeFileName)) {
            projectData[activeFileName] = codeTextarea.value;
            // Auto-save to local storage or indicate unsaved changes could be added here
        }
    });

    projectNameInput.addEventListener('change', () => {
        if (currentProjectID && projectData["index.html"]) {
            // Optional: Update title in index.html if project name changes
            // This is a simple replace, could be more robust with DOM parsing if needed
            const newTitle = projectNameInput.value.trim() || "Untitled Project";
            projectData["index.html"] = projectData["index.html"].replace(/<title>.*<\/title>/, `<title>${newTitle}</title>`);
            if (activeFileName === "index.html") {
                codeTextarea.value = projectData["index.html"];
            }
        }
    });
    
    // Initial load
    loadLastActiveProjectFromLocalStorage(); 
    if (!currentProjectID) { // If no last active project, prompt to create one or show empty state
        updateUIForNoProject();
    }

  </script>
</body>
</html>
