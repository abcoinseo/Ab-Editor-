<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AB Studio Code Editor</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; background: #1e1e2f; color: #fff; font-family: Arial, sans-serif; }

    /* --- Authentication Form Styles (Integrated) --- */
    .auth-page-container { /* This will wrap the auth form or the editor */
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column; /* Allows header and content below */
    }
    .auth-form-wrapper { /* Centering the auth form */
        flex-grow: 1; /* Takes remaining space to center form vertically */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .auth-container {
        background: #2d2d3c; padding: 30px 40px; border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center;
    }
    .auth-container h1 { margin-bottom: 25px; color: #82aaff; font-size: 1.8rem; }
    .input-group { margin-bottom: 20px; text-align: left; }
    .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc; }
    .input-group input {
        width: 100%; padding: 12px; border: 1px solid #4c4c66;
        background: #1e1e2f; color: #fff; border-radius: 4px; font-size: 1rem; box-sizing: border-box;
    }
    .auth-button {
        width: 100%; padding: 12px; background: #4CAF50; color: white;
        border: none; border-radius: 4px; font-size: 1rem; cursor: pointer;
        transition: background-color 0.2s; margin-top: 10px;
    }
    .auth-button:hover { background: #45a049; }
    .auth-button:disabled { background: #5a6268; cursor: not-allowed; }
    .toggle-form {
        color: #82aaff; cursor: pointer; margin-top: 20px;
        display: inline-block; font-size: 0.9rem;
    }
    .toggle-form:hover { text-decoration: underline; }
    .error-message { color: #ff6b6b; margin-top: 15px; font-size: 0.9rem; min-height: 1.2em; }
    .loading-spinner-auth { /* Renamed to avoid conflict if another spinner exists */
        border: 4px solid #f3f3f3; border-top: 4px solid #82aaff; border-radius: 50%;
        width: 20px; height: 20px; animation: spin 1s linear infinite;
        margin: 10px auto 0; display: none;
    }
    /* --- End Authentication Form Styles --- */


    .loading-overlay { /* For general app loading */
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(30,30,47,0.9); display:flex; flex-direction:column;
        align-items:center; justify-content:center; z-index:3000;
    }
    .loading-overlay .spinner {
        border: 5px solid #f3f3f3; border-top: 5px solid #82aaff; border-radius: 50%;
        width: 50px; height: 50px; animation: spin 1s linear infinite;
    }
    .loading-overlay p { margin-top: 15px; font-size: 1.1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    header {
        display: flex; justify-content: space-between; padding: 10px 20px;
        background: #292944; align-items: center;
    }
    header h1 { font-size: 1.2rem; }
    header .user-info { font-size: 0.9rem; display: flex; align-items: center;}
    header .user-info span { margin-right: 10px; }
    header .material-icons { cursor: pointer; margin-left:15px; }


    .app-content-wrapper { /* Wraps projects-panel and main-content when user is logged in */
        display: flex;
        height: calc(100% - 50px); /* Full height minus header */
    }

    .projects-panel {
        width: 250px; background: #262638; padding: 10px;
        display: flex; flex-direction: column; border-right: 1px solid #292944;
    }
    .projects-panel h2 { font-size: 1rem; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;}
    .project-list { flex-grow: 1; overflow-y: auto; margin-bottom: 10px;}
    .project-item {
        padding: 8px; margin: 5px 0; background: #3a3a4a;
        border-radius: 4px; cursor: pointer; font-size: 0.9rem;
    }
    .project-item.active { background: #4c4c66; font-weight: bold; }
    .action-button {
        display: block; width:100%; padding: 8px; background: #4CAF50;
        color: white; border: none; border-radius: 4px; text-align:center;
        cursor:pointer; margin-top:5px; font-size:0.9rem;
    }
    .action-button:hover { background: #45a049; }

    .sidebar {
        width: 220px; background: #2d2d3c; padding: 10px;
        overflow-y: auto; border-right: 1px solid #292944;
    }
    .file {
        padding: 8px; margin: 5px 0; background: #3c3c52;
        border-radius: 4px; cursor: pointer; word-break: break-all;
    }
    .file.active { background: #4c4c66; font-weight: bold; }
    
    .main-content { /* This div wraps sidebar and main-editor */
        flex: 1; display: flex; flex-direction: column;
    }
    .main-editor { flex: 1; display: flex; flex-direction: column; }
    .tabs {
        display: flex; background: #1e1e2f; padding: 5px 5px 0 5px;
        border-bottom: 1px solid #292944;
    }
    .tab {
        padding: 8px 15px; background: #2d2d3c; border-radius: 4px 4px 0 0;
        margin-right: 2px; cursor: pointer; font-size: 0.9rem;
    }
    .tab.active {
        background: #1e1e2f; border: 1px solid #292944;
        border-bottom: 1px solid #1e1e2f; position: relative; top: 1px;
    }
    .code-area {
        flex: 1; padding: 10px; background: #1e1e2f; color: #ccc;
        resize: none; border: none; width: 100%; font-family: monospace; outline: none;
    }
    .actions {
        display: flex; padding: 8px 10px; background: #292944;
        justify-content: space-between; align-items: center; border-top: 1px solid #33334d;
    }
    .actions .material-icons { cursor: pointer; margin: 0 8px; font-size: 20px; }
    .actions .material-icons:hover { color: #aaa; }

    /* Preview and Hosting Modals (Styles from previous answer) */
    .preview { /* ... */ }
    .preview-content { /* ... */ }
    .preview iframe { /* ... */ }
    .preview .close-preview-btn { /* ... */ }
    .modal-overlay { /* ... */ }
    .modal-overlay.visible { /* ... */ }
    .modal-content { /* ... */ }
    /* ... (rest of modal styles) ... */

    @keyframes spin-small { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .actions .material-icons.spinning { animation: spin-small 1s linear infinite; }

    @media (max-width: 768px) {
        .auth-form-wrapper { padding: 15px; } /* Adjust padding for auth form on mobile */
        .auth-container { padding: 20px; }

        .app-content-wrapper { flex-direction: column; }
        .projects-panel { width: 100%; max-height: 200px; order: -1; }
        .main-content { flex-direction: column; } /* Ensure main-content itself stacks */
        .sidebar { width: 100%; height: auto; max-height: 150px; display: flex; flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden; padding: 5px; }
        .file { flex-shrink: 0; margin: 5px; }
        .main-editor { flex: 1; min-height: 0; }
        .actions { padding: 5px; }
        .actions .material-icons { margin: 0 5px; font-size: 18px;}
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading AB Studio...</p>
  </div>

  <div class="auth-page-container"> <!-- This outer container is always present -->
    <header>
        <h1>AB Studio</h1>
        <div class="user-info" id="userInfo" style="display:none;">
            <span id="userEmail"></span>
            <span class="material-icons" onclick="logout()" title="Logout">logout</span>
        </div>
    </header>

    <!-- Authentication Form Area - Shown when not logged in -->
    <div class="auth-form-wrapper" id="authFormContainer" style="display:none;">
        <div class="auth-container">
            <h1 id="authFormTitle">Login</h1>
            <form id="authForm">
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="emailInput" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="passwordInput" required>
                </div>
                <button type="submit" class="auth-button" id="authSubmitButton">Login</button>
                <div class="error-message" id="authErrorMessage"></div>
                <div class="loading-spinner-auth" id="authLoadingSpinner"></div>
            </form>
            <p class="toggle-form" id="toggleAuthFormLink">Don't have an account? Register</p>
        </div>
    </div>

    <!-- Main Application Content - Shown when logged in -->
    <div class="app-content-wrapper" id="appContentContainer" style="display:none;">
        <div class="projects-panel" id="projectsPanel">
            <h2>My Projects</h2>
            <div id="projectList" class="project-list"></div>
            <button class="action-button" onclick="createNewProject()">Create New Project</button>
        </div>

        <div class="main-content" id="mainContentArea"> <!-- Renamed to avoid conflict with #mainContent -->
            <div class="sidebar" id="fileListContainer">
            </div>
            <div class="main-editor">
                <div class="tabs" id="tabsContainer"></div>
                <textarea id="code" class="code-area" spellcheck="false" placeholder="Select a file to start coding..."></textarea>
                <div class="actions">
                    <div>
                        <span class="material-icons" onclick="addFileToProject()" title="Add new file to project">note_add</span>
                        <span class="material-icons" onclick="renameFile()" title="Rename current file">edit</span>
                        <span class="material-icons" onclick="deleteFile()" title="Delete current file">delete</span>
                    </div>
                    <div>
                        <span class="material-icons" onclick="saveProjectToFirebase()" title="Save Project to Cloud">cloud_upload</span>
                        <span class="material-icons" onclick="hostProject()" title="Host Project Publicly">public</span>
                        <span class="material-icons" onclick="openPreview()" title="Preview Current File (index.html recommended)">preview</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div> <!-- End auth-page-container -->


  <div class="preview" id="preview">
    <div class="preview-content">
      <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation"></iframe>
      <span class="material-icons close-preview-btn" onclick="closePreview()">close</span>
    </div>
  </div>

  <div class="modal-overlay" id="hostingPopupOverlay">
    <div class="modal-content">
      <h2>Project Hosted!</h2>
      <p>Your project is now publicly accessible at:</p>
      <input type="text" id="hostedLinkInput" readonly>
      <div class="modal-actions">
        <button onclick="copyHostedLink()" class="modal-button copy-button">Copy Link</button>
        <button onclick="closeHostingPopup()" class="modal-button close-button">Close</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = { // YOUR PROVIDED CONFIG
        apiKey: "AIzaSyD3kO_ULF76RJkJf1yhvo5cdM4Hoqo4fHA",
        authDomain: "abcoinseo-e2f66.firebaseapp.com",
        databaseURL: "https://abcoinseo-e2f66-default-rtdb.firebaseio.com",
        projectId: "abcoinseo-e2f66",
        storageBucket: "abcoinseo-e2f66.firebasestorage.app",
        messagingSenderId: "396837162872",
        appId: "1:396837162872:web:c204ca5c36f5d2d87bc28d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const userInfoDiv = document.getElementById('userInfo');
    const userEmailSpan = document.getElementById('userEmail');
    
    // Auth Form Elements
    const authFormContainer = document.getElementById('authFormContainer');
    const authForm = document.getElementById('authForm');
    const emailInputElement = document.getElementById('emailInput'); // Renamed to avoid conflict
    const passwordInputElement = document.getElementById('passwordInput'); // Renamed
    const authFormTitle = document.getElementById('authFormTitle');
    const authSubmitButton = document.getElementById('authSubmitButton');
    const toggleAuthFormLink = document.getElementById('toggleAuthFormLink');
    const authErrorMessageDiv = document.getElementById('authErrorMessage');
    const authLoadingSpinner = document.getElementById('authLoadingSpinner');
    let isLoginMode = true;

    // App Content Elements
    const appContentContainer = document.getElementById('appContentContainer');
    const projectsPanel = document.getElementById('projectsPanel');
    const projectListDiv = document.getElementById('projectList');
    const mainContentArea = document.getElementById('mainContentArea'); // Renamed
    const fileListContainer = document.getElementById('fileListContainer');
    const tabsContainer = document.getElementById('tabsContainer');
    const codeTextarea = document.getElementById('code');
    const hostingPopupOverlay = document.getElementById('hostingPopupOverlay');
    const hostedLinkInput = document.getElementById('hostedLinkInput');

    let currentUser = null;
    let userProjects = {}; 
    let currentProjectId = null;
    let currentOpenFile = null;
    let localProjectData = {};

    // Sanitization Functions (Keep these from previous answer)
    const FSK_REPLACEMENTS = { /* ... */ };
    function sanitizeKeyForFirebase(key) { /* ... */ }
    function desanitizeKeyFromFirebase(sanitizedKey) { /* ... */ }
    function sanitizeFileObjectForFirebase(filesObject) { /* ... */ }
    function desanitizeFileObjectFromFirebase(firebaseFilesObject) { /* ... */ }
    // (Paste the full sanitize/desanitize functions here from previous answer)
    const FSK_REPLACEMENTS_FULL = { // Pasted for completeness
        '.': '_FSK_DOT_FSK_', '#': '_FSK_HASH_FSK_', '$': '_FSK_DOLLAR_FSK_',
        '[': '_FSK_LBRACKET_FSK_', ']': '_FSK_RBRACKET_FSK_', '/': '_FSK_SLASH_FSK_'
    };
    function sanitizeKeyForFirebase_FULL(key) {
        let sanitizedKey = key;
        for (const char in FSK_REPLACEMENTS_FULL) {
            sanitizedKey = sanitizedKey.split(char).join(FSK_REPLACEMENTS_FULL[char]);
        }
        return sanitizedKey;
    }
    function desanitizeKeyFromFirebase_FULL(sanitizedKey) {
        let key = sanitizedKey;
        for (const char in FSK_REPLACEMENTS_FULL) {
            key = key.split(FSK_REPLACEMENTS_FULL[char]).join(char);
        }
        return key;
    }
    function sanitizeFileObjectForFirebase_FULL(filesObject) {
        if (!filesObject) return {};
        const sanitizedFiles = {};
        for (const originalFilename in filesObject) {
            sanitizedFiles[sanitizeKeyForFirebase_FULL(originalFilename)] = filesObject[originalFilename];
        }
        return sanitizedFiles;
    }
    function desanitizeFileObjectFromFirebase_FULL(firebaseFilesObject) {
        if (!firebaseFilesObject) return {};
        const originalFiles = {};
        for (const sanitizedKey in firebaseFilesObject) {
            originalFiles[desanitizeKeyFromFirebase_FULL(sanitizedKey)] = firebaseFilesObject[sanitizedKey];
        }
        return originalFiles;
    }
    // Use the _FULL versions or rename them to the shorter ones you were using consistently
    // For this example, I'll assume the shorter names were intended and you'll paste their definitions
    // Let's use the shorter names for consistency with the rest of the code
    // Assuming sanitizeKeyForFirebase, desanitizeKeyFromFirebase, etc. are correctly defined as above.


    function showLoading(message = "Loading...") {
        if (loadingOverlay) {
            loadingOverlay.querySelector('p').textContent = message;
            loadingOverlay.style.display = 'flex';
        }
    }
    function hideLoading() {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }

    // --- Integrated Authentication Logic ---
    function setAuthLoading(isLoading) {
        authLoadingSpinner.style.display = isLoading ? 'block' : 'none';
        authSubmitButton.disabled = isLoading;
    }

    toggleAuthFormLink.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        authFormTitle.textContent = isLoginMode ? 'Login' : 'Register';
        authSubmitButton.textContent = isLoginMode ? 'Login' : 'Register';
        toggleAuthFormLink.textContent = isLoginMode ? "Don't have an account? Register" : "Already have an account? Login";
        authErrorMessageDiv.textContent = '';
        emailInputElement.value = '';
        passwordInputElement.value = '';
    });

    authForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = emailInputElement.value;
        const password = passwordInputElement.value;
        authErrorMessageDiv.textContent = '';
        setAuthLoading(true);

        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => { authErrorMessageDiv.textContent = error.message; })
                .finally(() => { setAuthLoading(false); });
        } else {
            auth.createUserWithEmailAndPassword(email, password)
                .catch((error) => { authErrorMessageDiv.textContent = error.message; })
                .finally(() => { setAuthLoading(false); });
        }
    });

    auth.onAuthStateChanged(user => {
        showLoading("Checking auth state...");
        if (user) {
            currentUser = user;
            userEmailSpan.textContent = user.email;
            userInfoDiv.style.display = 'flex';
            
            authFormContainer.style.display = 'none'; // Hide auth form
            appContentContainer.style.display = 'flex'; // Show app content
            mainContentArea.style.display = 'none'; // Hide editor part until project selected
            
            loadUserProjects(); // This will also call hideLoading() when done
        } else {
            currentUser = null;
            userInfoDiv.style.display = 'none';
            
            appContentContainer.style.display = 'none'; // Hide app content
            authFormContainer.style.display = 'flex';  // Show auth form
            
            // Clear app state
            currentProjectId = null;
            currentOpenFile = null;
            userProjects = {};
            localProjectData = {};
            projectListDiv.innerHTML = '';
            fileListContainer.innerHTML = '';
            tabsContainer.innerHTML = '';
            codeTextarea.value = '';

            hideLoading();
        }
    });

    function logout() {
        auth.signOut().then(() => {
            console.log("User signed out.");
            // onAuthStateChanged will handle UI swap
        }).catch(error => {
            console.error("Sign out error", error);
            alert("Error signing out: " + error.message);
        });
    }

    // --- Project Management, File Management, Saving, Hosting (Keep these from previous answer) ---
    // Make sure to use the _FULL versions of sanitize/desanitize functions if you pasted those,
    // or ensure the shorter versions are correctly defined above.
    // For brevity, I'm indicating where to paste them.

    function generateRandomId(length = 12) { /* ... Paste from previous ... */ }
    async function createNewProject() { /* ... Paste, ensuring sanitizeFileObjectForFirebase is used for DB save ... */ }
    async function loadUserProjects() { /* ... Paste ... */ }
    function renderProjectList() { /* ... Paste ... */ }
    async function openProject(projectId) { /* ... Paste, ensuring desanitizeFileObjectFromFirebase is used for DB load ... */ }
    
    function renderFileList() { /* ... Paste ... */ }
    function renderTabs() { /* ... Paste ... */ }
    function addFileToProject() { /* ... Paste ... */ }
    function openFile(originalFilename) { /* ... Paste ... */ }
    codeTextarea.addEventListener('input', () => { /* ... Paste ... */ });
    function renameFile() { /* ... Paste ... */ }
    function deleteFile() { /* ... Paste ... */ }

    async function saveProjectToFirebase() { /* ... Paste, ensuring sanitizeFileObjectForFirebase is used for DB save ... */ }
    async function hostProject() { /* ... Paste, ensuring sanitizeFileObjectForFirebase is used for DB save ... */ }
    
    function showHostingPopup(url) { /* ... Paste ... */ }
    function closeHostingPopup() { /* ... Paste ... */ }
    function copyHostedLink() { /* ... Paste ... */ }
    function openPreview() { /* ... Paste ... */ }
    function closePreview() { /* ... Paste ... */ }


    // --- Initial Load ---
    showLoading(); 
    // Auth state listener will handle the rest of the UI setup.
  </script>
</body>
</html>
