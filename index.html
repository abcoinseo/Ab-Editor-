<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AB Studio Code Editor</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ... (Your existing CSS from the previous full answer) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; background: #1e1e2f; color: #fff; font-family: Arial, sans-serif; }
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(30,30,47,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000; }
    .loading-overlay .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #82aaff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    .loading-overlay p { margin-top: 15px; font-size: 1.1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    header { display: flex; justify-content: space-between; padding: 10px 20px; background: #292944; align-items: center; }
    header h1 { font-size: 1.2rem; }
    header .user-info { font-size: 0.9rem; display: flex; align-items: center;}
    header .user-info span { margin-right: 10px; }
    header .material-icons, header .header-button { cursor: pointer; margin-left:15px; }
    .header-button { background: #4c4c66; color:white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size:0.9rem; }
    .header-button:hover { background: #5c5c7a; }

    .editor-container { display: flex; height: calc(100% - 50px); } /* Main content area */
    .projects-panel { width: 250px; background: #262638; padding: 10px; display: flex; flex-direction: column; border-right: 1px solid #292944;}
    .projects-panel h2 { font-size: 1rem; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;}
    .project-list { flex-grow: 1; overflow-y: auto; margin-bottom: 10px;}
    .project-item { padding: 8px; margin: 5px 0; background: #3a3a4a; border-radius: 4px; cursor: pointer; font-size: 0.9rem;}
    .project-item.active { background: #4c4c66; font-weight: bold; }
    .action-button { display: block; width:100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; text-align:center; cursor:pointer; margin-top:5px; font-size:0.9rem;}
    .action-button:hover { background: #45a049; }

    .sidebar { width: 220px; background: #2d2d3c; padding: 10px; overflow-y: auto; border-right: 1px solid #292944;}
    .file { padding: 8px; margin: 5px 0; background: #3c3c52; border-radius: 4px; cursor: pointer; word-break: break-all; }
    .file.active { background: #4c4c66; font-weight: bold; }
    
    .main-content { display: none; /* Hidden until a project is loaded */ flex: 1; flex-direction: column;}
    .main-editor { flex: 1; display: flex; flex-direction: column; }
    .tabs { display: flex; background: #1e1e2f; padding: 5px 5px 0 5px; border-bottom: 1px solid #292944;}
    .tab { padding: 8px 15px; background: #2d2d3c; border-radius: 4px 4px 0 0; margin-right: 2px; cursor: pointer; font-size: 0.9rem;} /* Make tabs clickable */
    .tab.active { background: #1e1e2f; border: 1px solid #292944; border-bottom: 1px solid #1e1e2f; position: relative; top: 1px; }
    .code-area { flex: 1; padding: 10px; background: #1e1e2f; color: #ccc; resize: none; border: none; width: 100%; font-family: monospace; outline: none; }
    .actions { display: flex; padding: 8px 10px; background: #292944; justify-content: space-between; align-items: center; border-top: 1px solid #33334d;}
    .actions .material-icons { cursor: pointer; margin: 0 8px; font-size: 20px; }
    .actions .material-icons:hover { color: #aaa; }

    .preview { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; align-items: center; justify-content: center;}
    .preview-content { background: #fff; color: #000; width: 90%; height: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.3); position: relative; }
    .preview iframe { width: 100%; height: 100%; border: none; }
    .preview .close-preview-btn { position:absolute; top:10px; right:10px; cursor:pointer; font-size:30px; color: #333; background: white; border-radius: 50%; padding: 2px;}
    
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7);
      display: none; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; display: flex;}
    .modal-content {
      background: #2d2d3c; color: #fff; padding: 25px 30px; border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); width: 90%; max-width: 550px; text-align: center;
      transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .modal-content h2 { margin-top: 0; margin-bottom: 15px; color: #82aaff; font-size: 1.6rem; }
    .modal-content p { margin-bottom: 12px; font-size: 0.95rem; color: #ccc; }
    #hostedLinkInput {
      width: 100%; padding: 12px; margin-bottom: 25px; border: 1px solid #4c4c66;
      border-radius: 4px; background: #1e1e2f; color: #e0e0e0; font-size: 0.9rem;
      text-align: left; font-family: monospace;
    }
    .modal-actions { display: flex; justify-content: center; gap: 15px; }
    .modal-button {
      padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer;
      font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s, transform 0.1s;
    }
    .modal-button:active { transform: scale(0.98); }
    .modal-button.copy-button { background-color: #4CAF50; color: white; }
    .modal-button.copy-button:hover { background-color: #45a049; }
    .modal-button.close-button { background-color: #6c757d; color: white; }
    .modal-button.close-button:hover { background-color: #5a6268; }

    @keyframes spin-small { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .actions .material-icons.spinning { animation: spin-small 1s linear infinite; }

    @media (max-width: 768px) {
      .editor-container { flex-direction: column; height: calc(100% - 48px); }
      .projects-panel { width: 100%; max-height: 200px; order: -1; }
      .sidebar { width: 100%; height: auto; max-height: 150px; display: flex; flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden; padding: 5px; }
      .file { flex-shrink: 0; margin: 5px; }
      .main-editor { flex: 1; min-height: 0; }
      .actions { padding: 5px; }
      .actions .material-icons { margin: 0 5px; font-size: 18px;}
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading AB Studio...</p>
  </div>

  <header>
    <h1>AB Studio</h1>
    <div class="user-info" id="userInfo" style="display:none;">
      <span id="userEmail"></span>
      <span class="material-icons" onclick="logout()" title="Logout">logout</span>
    </div>
    <a href="auth.html" id="loginButton" class="header-button" style="display:none;">Login / Register</a>
  </header>

  <div class="editor-container">
    <div class="projects-panel" id="projectsPanel" style="display:none;">
        <h2>My Projects</h2>
        <div id="projectList" class="project-list"></div>
        <button class="action-button" onclick="createNewProject()">Create New Project</button>
    </div>

    <div class="main-content" id="mainContent">
        <div class="sidebar" id="fileListContainer"> <!-- Renamed for clarity -->
        </div>
        <div class="main-editor">
            <div class="tabs" id="tabsContainer"></div>
            <textarea id="code" class="code-area" spellcheck="false" placeholder="Select a file to start coding..."></textarea>
            <div class="actions">
                <div>
                    <span class="material-icons" onclick="addFileToProject()" title="Add new file to project">note_add</span>
                    <span class="material-icons" onclick="renameFile()" title="Rename current file">edit</span>
                    <span class="material-icons" onclick="deleteFile()" title="Delete current file">delete</span>
                </div>
                <div>
                    <span class="material-icons" onclick="saveProjectToFirebase()" title="Save Project to Cloud">cloud_upload</span>
                    <span class="material-icons" onclick="hostProject()" title="Host Project Publicly">public</span>
                    <span class="material-icons" onclick="openPreview()" title="Preview Current File (index.html recommended)">preview</span>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="preview" id="preview">
    <div class="preview-content">
      <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation"></iframe>
      <span class="material-icons close-preview-btn" onclick="closePreview()">close</span>
    </div>
  </div>

  <div class="modal-overlay" id="hostingPopupOverlay">
    <div class="modal-content">
      <h2>Project Hosted!</h2>
      <p>Your project is now publicly accessible at:</p>
      <input type="text" id="hostedLinkInput" readonly>
      <div class="modal-actions">
        <button onclick="copyHostedLink()" class="modal-button copy-button">Copy Link</button>
        <button onclick="closeHostingPopup()" class="modal-button close-button">Close</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = { // YOUR PROVIDED CONFIG
        apiKey: "AIzaSyD3kO_ULF76RJkJf1yhvo5cdM4Hoqo4fHA",
        authDomain: "abcoinseo-e2f66.firebaseapp.com",
        databaseURL: "https://abcoinseo-e2f66-default-rtdb.firebaseio.com",
        projectId: "abcoinseo-e2f66",
        storageBucket: "abcoinseo-e2f66.firebasestorage.app",
        messagingSenderId: "396837162872",
        appId: "1:396837162872:web:c204ca5c36f5d2d87bc28d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const userInfoDiv = document.getElementById('userInfo');
    const userEmailSpan = document.getElementById('userEmail');
    const loginButton = document.getElementById('loginButton');
    const projectsPanel = document.getElementById('projectsPanel');
    const projectListDiv = document.getElementById('projectList');
    const mainContentDiv = document.getElementById('mainContent');
    const fileListContainer = document.getElementById('fileListContainer'); // Corrected ID
    const tabsContainer = document.getElementById('tabsContainer');
    const codeTextarea = document.getElementById('code');
    const hostingPopupOverlay = document.getElementById('hostingPopupOverlay');
    const hostedLinkInput = document.getElementById('hostedLinkInput');

    let currentUser = null;
    let userProjects = {}; 
    let currentProjectId = null;
    let currentOpenFile = null; // Stores original filename (e.g., "index.html")
    let localProjectData = {}; // { projectId: { name: "...", files: { "index.html": "content", ... } } }

    // --- Sanitization Constants and Functions ---
    const FSK_REPLACEMENTS = {
        '.': '_FSK_DOT_FSK_',
        '#': '_FSK_HASH_FSK_',
        '$': '_FSK_DOLLAR_FSK_',
        '[': '_FSK_LBRACKET_FSK_',
        ']': '_FSK_RBRACKET_FSK_',
        '/': '_FSK_SLASH_FSK_' // Though filenames shouldn't contain this
    };

    function sanitizeKeyForFirebase(key) {
        let sanitizedKey = key;
        for (const char in FSK_REPLACEMENTS) {
            sanitizedKey = sanitizedKey.split(char).join(FSK_REPLACEMENTS[char]);
        }
        return sanitizedKey;
    }

    function desanitizeKeyFromFirebase(sanitizedKey) {
        let key = sanitizedKey;
        for (const char in FSK_REPLACEMENTS) {
            key = key.split(FSK_REPLACEMENTS[char]).join(char);
        }
        return key;
    }

    function sanitizeFileObjectForFirebase(filesObject) {
        if (!filesObject) return {};
        const sanitizedFiles = {};
        for (const originalFilename in filesObject) {
            sanitizedFiles[sanitizeKeyForFirebase(originalFilename)] = filesObject[originalFilename];
        }
        return sanitizedFiles;
    }

    function desanitizeFileObjectFromFirebase(firebaseFilesObject) {
        if (!firebaseFilesObject) return {};
        const originalFiles = {};
        for (const sanitizedKey in firebaseFilesObject) {
            originalFiles[desanitizeKeyFromFirebase(sanitizedKey)] = firebaseFilesObject[sanitizedKey];
        }
        return originalFiles;
    }


    function showLoading(message = "Loading...") { /* ... same as before ... */ }
    function hideLoading() { /* ... same as before ... */ }

    // --- Authentication Logic ---
    auth.onAuthStateChanged(user => { /* ... same as before ... */ });
    function logout() { /* ... same as before ... */ }

    // --- Project Management ---
    function generateRandomId(length = 12) { /* ... same as before ... */ }

    async function createNewProject() {
        if (!currentUser) { alert("Please login..."); return; }
        const projectName = prompt("Enter new project name:", "My Web Project");
        if (!projectName || projectName.trim() === "") { alert("Project name cannot be empty."); return; }

        const projectId = generateRandomId();
        const newProjectData = {
            name: projectName.trim(),
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            owner: currentUser.uid,
            // Files use ORIGINAL filenames as keys locally
            files: {
                "index.html": `<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <title>${projectName.trim()}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Hello from ${projectName.trim()}!</h1>\n  <p>Edit this content in index.html.</p>\n  <script src="script.js"><\/script>\n</body>\n</html>`,
                "style.css": `body {\n  font-family: Arial, sans-serif;\n  margin: 20px;\n  background-color: #f0f8ff;\n  color: #333;\n}\nh1 { color: #0066cc; }`,
                "script.js": `console.log("Project '${projectName.trim()}' script.js loaded!");\n\n// Your JavaScript code here`
            }
        };

        showLoading("Creating project...");
        try {
            // When saving to Firebase, sanitize the 'files' object's keys
            const dataToSaveToFirebase = {
                ...newProjectData,
                files: sanitizeFileObjectForFirebase(newProjectData.files)
            };
            await db.ref(`users/${currentUser.uid}/projects/${projectId}`).set(dataToSaveToFirebase);
            
            // Store locally with original file names
            userProjects[projectId] = { name: newProjectData.name, id: projectId }; 
            localProjectData[projectId] = JSON.parse(JSON.stringify(newProjectData)); // Deep copy
            
            renderProjectList();
            openProject(projectId);
            alert(`Project "${projectName.trim()}" created successfully!`);
        } catch (error) {
            console.error("Error creating project:", error);
            alert("Error creating project: " + error.message);
        } finally {
            hideLoading();
        }
    }

    async function loadUserProjects() {
        if (!currentUser) return;
        showLoading("Loading projects...");
        try {
            const snapshot = await db.ref(`users/${currentUser.uid}/projects`).orderByChild('name').once('value');
            userProjects = {};
            localProjectData = {};
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const project = childSnapshot.val();
                    userProjects[childSnapshot.key] = { name: project.name, id: childSnapshot.key };
                    // Project file content will be loaded when opening the project
                });
            }
            renderProjectList();
        } catch (error) {
            console.error("Error loading projects:", error);
            alert("Error loading projects: " + error.message);
        } finally {
            hideLoading();
        }
    }

    function renderProjectList() { /* ... same as before ... */ }

    async function openProject(projectId) {
        if (!currentUser) return;
        if (currentProjectId === projectId && mainContentDiv.style.display === 'flex') return;

        showLoading(`Opening project ${userProjects[projectId]?.name || projectId}...`);
        try {
            if (!localProjectData[projectId] || !localProjectData[projectId].files) {
                const snapshot = await db.ref(`users/${currentUser.uid}/projects/${projectId}`).once('value');
                if (!snapshot.exists()) throw new Error("Project not found in database.");
                
                const projectDataFromDb = snapshot.val();
                // De-sanitize file keys when loading from Firebase
                if (projectDataFromDb.files) {
                    projectDataFromDb.files = desanitizeFileObjectFromFirebase(projectDataFromDb.files);
                } else {
                    projectDataFromDb.files = {}; // Ensure files object exists
                }
                localProjectData[projectId] = projectDataFromDb;
            }
            
            currentProjectId = projectId;
            currentOpenFile = null; 
            mainContentDiv.style.display = 'flex';
            codeTextarea.value = '';
            codeTextarea.placeholder = "Select a file or create one.";
            
            renderProjectList();
            renderFileList();
            renderTabs();

            const filesInProject = Object.keys(localProjectData[currentProjectId].files);
            if (filesInProject.includes("index.html")) {
                openFile("index.html");
            } else if (filesInProject.length > 0) {
                openFile(filesInProject.sort()[0]); // Open first file alphabetically
            }
        } catch (error) {
            console.error("Error opening project:", error);
            alert("Error opening project: " + error.message);
            currentProjectId = null;
            mainContentDiv.style.display = 'none';
        } finally {
            hideLoading();
        }
    }

    // --- File Management (within a project) ---
    // All functions here (renderFileList, renderTabs, addFileToProject, openFile, renameFile, deleteFile)
    // will work with ORIGINAL filenames because `localProjectData` and `currentOpenFile` use them.

    function renderFileList() {
        fileListContainer.innerHTML = '';
        if (!currentProjectId || !localProjectData[currentProjectId] || !localProjectData[currentProjectId].files) {
            fileListContainer.innerHTML = '<p style="font-size:0.8em; color:#888;text-align:center;">No files.</p>';
            return;
        }
        const files = localProjectData[currentProjectId].files;
        Object.keys(files).sort().forEach(originalFilename => { // Iterate original filenames
            const div = document.createElement('div');
            div.className = 'file' + (originalFilename === currentOpenFile ? ' active' : '');
            div.textContent = originalFilename; // Display original filename
            div.onclick = () => openFile(originalFilename); // Pass original filename
            fileListContainer.appendChild(div);
        });
    }

    function renderTabs() {
        tabsContainer.innerHTML = '';
        if (!currentOpenFile) return; // currentOpenFile stores original filename
        const tab = document.createElement('div');
        tab.className = 'tab active';
        tab.textContent = currentOpenFile; // Display original filename
        tabsContainer.appendChild(tab);
    }

    function addFileToProject() {
        // ... (logic remains same, uses original filenames for prompts and keys in localProjectData)
        if (!currentProjectId) { alert("Open a project first."); return; }
        const filename = prompt("Enter new file name (e.g., style.css):");
        if (!filename || filename.trim() === "") { alert("Filename cannot be empty."); return; }
        const trimmedFilename = filename.trim(); // This is the original filename
        if (localProjectData[currentProjectId].files.hasOwnProperty(trimmedFilename)) {
            alert("A file with this name already exists in the project.");
            return;
        }
        // Add default content based on extension...
        let defaultContent = `// ${trimmedFilename}`;
        if (trimmedFilename.endsWith('.html')) defaultContent = `<!DOCTYPE html>\n<html>\n<head><title>${trimmedFilename}</title></head>\n<body>\n  <!-- Content for ${trimmedFilename} -->\n</body>\n</html>`;
        else if (trimmedFilename.endsWith('.css')) defaultContent = `/* Styles for ${trimmedFilename} */\nbody {}`;
        else if (trimmedFilename.endsWith('.js')) defaultContent = `// Script for ${trimmedFilename}\nconsole.log('${trimmedFilename} loaded.');`;

        localProjectData[currentProjectId].files[trimmedFilename] = defaultContent;
        openFile(trimmedFilename); // Opens using original filename
    }

    function openFile(originalFilename) {
        // ... (logic remains same, uses originalFilename for localProjectData access and currentOpenFile)
        if (!currentProjectId || !localProjectData[currentProjectId] || !localProjectData[currentProjectId].files.hasOwnProperty(originalFilename)) {
            return;
        }
        currentOpenFile = originalFilename; // Store original filename
        codeTextarea.value = localProjectData[currentProjectId].files[originalFilename];
        codeTextarea.focus();
        renderFileList(); 
        renderTabs();     
    }

    codeTextarea.addEventListener('input', () => {
        // ... (logic remains same, uses original currentOpenFile)
        if (currentProjectId && currentOpenFile && localProjectData[currentProjectId] && localProjectData[currentProjectId].files) {
            localProjectData[currentProjectId].files[currentOpenFile] = codeTextarea.value;
        }
    });

    function renameFile() { /* ... (logic uses original filenames for prompts and localProjectData keys) ... */ }
    function deleteFile() { /* ... (logic uses original filenames for confirm and localProjectData keys) ... */ }


    // --- Saving and Hosting ---
    async function saveProjectToFirebase() {
        if (!currentUser || !currentProjectId || !localProjectData[currentProjectId]) {
            alert("No project open or not logged in."); return;
        }
        showLoading("Saving project...");
        
        // Sanitize file keys before saving to Firebase
        const filesToSaveInDb = sanitizeFileObjectForFirebase(localProjectData[currentProjectId].files);

        const projectDataToSave = {
            name: localProjectData[currentProjectId].name,
            files: filesToSaveInDb, // Use the sanitized files object
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            owner: currentUser.uid
            // Include other metadata like createdAt if it exists on localProjectData[currentProjectId]
            // createdAt: localProjectData[currentProjectId].createdAt || firebase.database.ServerValue.TIMESTAMP,
        };

        try {
            await db.ref(`users/${currentUser.uid}/projects/${currentProjectId}`).update(projectDataToSave);
            if(userProjects[currentProjectId]) { // Update project name in local cache if changed
                 userProjects[currentProjectId].name = projectDataToSave.name;
                 renderProjectList();
            }
            alert(`Project "${projectDataToSave.name}" saved to Firebase!`);
        } catch (error) {
            console.error("Error saving project:", error);
            alert("Error saving project: " + error.message);
        } finally {
            hideLoading();
        }
    }

    async function hostProject() {
        if (!currentUser || !currentProjectId || !localProjectData[currentProjectId]) {
            alert("Please open and save a project to host it."); return;
        }
        await saveProjectToFirebase(); // Ensure latest is saved

        const originalProjectName = localProjectData[currentProjectId].name;
        const hostedProjectId = currentProjectId; 
        const filesToHostRaw = localProjectData[currentProjectId].files;

        if (!filesToHostRaw || Object.keys(filesToHostRaw).length === 0) {
            alert("Project has no files to host."); return;
        }
        if (!filesToHostRaw["index.html"]) { // Check for original "index.html"
            alert("Project must have an 'index.html' file to be hosted."); return;
        }

        const filesToHostSanitized = sanitizeFileObjectForFirebase(filesToHostRaw);
        const firebaseHostedPath = `hosted_content/${hostedProjectId}`;
        
        // ... (rest of the hostProject logic for UI updates and Firebase set) ...
        const hostButton = document.querySelector('.actions .material-icons[onclick="hostProject()"]');
        const originalIconText = hostButton.textContent;
        hostButton.textContent = 'sync'; hostButton.classList.add('spinning');
        showLoading(`Hosting project "${originalProjectName}"...`);

        try {
            await db.ref(firebaseHostedPath).set({
                files: filesToHostSanitized,
                originalProjectName: originalProjectName,
                sourceProjectId: currentProjectId,
                owner: currentUser.uid,
                lastHosted: firebase.database.ServerValue.TIMESTAMP
            });
            
            let baseUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$|auth\.html$/, '')}`;
            if (!baseUrl.endsWith('/')) baseUrl += '/';
            const publicUrl = `${baseUrl}view.html#${hostedProjectId}`;

            alert(`Project "${originalProjectName}" is now hosted!`);
            showHostingPopup(publicUrl);

        } catch (error) { /* ... error handling ... */ }
        finally { /* ... reset button, hide loading ... */ }
    }
    
    function showHostingPopup(url) { /* ... same ... */ }
    function closeHostingPopup() { /* ... same ... */ }
    function copyHostedLink() { /* ... same ... */ }

    function openPreview() {
        // This function uses localProjectData.files which has original filenames
        // The inlining logic should work fine with original filenames
        if (!currentProjectId || !localProjectData[currentProjectId] || !localProjectData[currentProjectId].files) {
            alert("No project or files open to preview."); return;
        }
        const files = localProjectData[currentProjectId].files; // Original filenames as keys
        let htmlToPreview = "";

        if (currentOpenFile && currentOpenFile.endsWith('.html')) {
            htmlToPreview = files[currentOpenFile];
        } else if (files["index.html"]) {
            htmlToPreview = files["index.html"];
            if (currentOpenFile) alert("Previewing 'index.html'. To preview a different HTML file, please open it first.");
        } else {
            alert("No '.html' file open and 'index.html' not found in project."); return;
        }
        
        // Inlining logic (uses original filenames for lookups in `files` object)
        htmlToPreview = htmlToPreview.replace(/<link.*?href=["'](.*?)["'][^>]*>/gi, (match, href) => {
            const cleanHref = href.startsWith('./') ? href.substring(2) : href;
            if (files[cleanHref] && cleanHref.endsWith('.css')) { // files[cleanHref] uses original name
                return `<style data-inlined-href="${cleanHref}">\n${files[cleanHref]}\n</style>`;
            }
            return match;
        });
        htmlToPreview = htmlToPreview.replace(/<script.*?src=["'](.*?)["'][^>]*><\/script>/gi, (match, src) => {
            const cleanSrc = src.startsWith('./') ? src.substring(2) : src;
            if (files[cleanSrc] && cleanSrc.endsWith('.js')) { // files[cleanSrc] uses original name
                return `<script data-inlined-src="${cleanSrc}">\n${files[cleanSrc]}\n<\/script>`;
            }
            return match;
        });

        const iframe = document.getElementById('previewFrame');
        iframe.srcdoc = htmlToPreview;
        document.getElementById('preview').style.display = 'flex';
    }
    function closePreview() { /* ... same ... */ }

    // --- Initial Load ---
    showLoading(); 
    // Auth state listener will handle the rest
  </script>
</body>
</html>
